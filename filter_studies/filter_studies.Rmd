---
title: "Filtering seroprevalence studies from Serotracker data"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
rm(list = ls())
```

```{r library}
library(tidyverse)
```

# 1. Data extraction
This data is exactly the same as the one that can be downloaded from Serotracker website.

```{r}
# Serotracker data
path_data <- "~/ubuntu_research/Research/psi_hdi/Data/serotracker/"
setwd(path_data)
df <- read.csv("serotracker_full_data.csv")
```

## 1. Refining the data
Retaining relevant columns
```{r}
df <- df %>% select(
  source_name,
  source_type,
  estimate_grade,
  country,
  state,
  city,
  study_inclusion_criteria,
  study_exclusion_criteria,
  sex,
  sampling_start_date,
  sampling_end_date,
  population_group,
  age,
  denominator_value,
  serum_pos_prevalence,
  seroprev_95_ci_lower,
  seroprev_95_ci_upper,
  sampling_method,
  test_name,
  test_manufacturer,
  test_type,
  isotypes,
  antibody_target,
  test_validation,
  sensitivity,
  specificity,
  first_author,
  url
)

# Some countries have different names, we will standardize them to align with the
# naming convention used in our datasets.

df <- df %>% 
  mutate(country = case_when(
    country == "United States of America" ~ "US",
    country == "United Kingdom of Great Britain and Northern Ireland" ~ "UK",
    country == "Iran (Islamic Republic of)" ~ "Iran",
    TRUE ~ country
  ))

# Saving the filtered data
# setwd(path_data)
# write.csv(df, "serotracker_filtered_data.csv", row.names = FALSE)
```
In the dataset, `source_name` refers to the study name, and is unique for a study. We therefore,\n
filtering out studies based on it.

```{r}
# Total number of studies from SeroTracker data
n_total <- length(unique(df$source_name))
n_total
```
By 24 Dec, 2025, I found 2844 unique studies in the data.\n
Next, we filtered out studies based on the following criteria:\n
1. Sample frame: `Household and community samples`, and `Multiple general populations`, and `Multiple populations`\n
2. Denominator value >= 500\n
3. Study period: starting from 2020-01-30 to 2020-12-31
4. Sex = All\n
5. Age: `Adults (18-64 years)`, and `Multiple groups`

```{r}

# Filtering the dataframe based on the criteria mentioned above one by one

## Filter of sample frame
df_sample <- df %>% 
  filter(
    population_group %in% c(
      "Household and community samples",
      "Multiple general populations",
      "Multiple populations")
    )

### Number of unique studies after sample frame filter
n_sample <- length(unique(df_sample$source_name))
print(paste0("Number of studies after sample frame filter: ", n_sample))

### Number of excluded studies after sample frame filter
n_excluded_sample <- n_total - n_sample
print(paste0("Number of excluded studies after sample frame filter: ", n_excluded_sample))

## Filter of denominator value
df_denom <- df_sample %>%
  filter(denominator_value >= 500)

### Number of unique studies after denominator value filter
n_denom <- length(unique(df_denom$source_name))
print(paste0("Number of studies after denominator value filter: ", n_denom))

### Number of excluded studies after denominator value filter
n_excluded_denom <- n_sample - n_denom
print(paste0("Number of excluded studies after denominator value filter: ", n_excluded_denom))

## Filter of study period
df_period <- df_denom %>%
  filter(
    sampling_start_date >= as.Date("2020-01-30"), 
    sampling_end_date <= as.Date("2020-12-31")
    )

### Number of unique studies after study period filter
n_period <- length(unique(df_period$source_name))
print(paste0("Number of studies after study period filter: ", n_period))

### Number of excluded studies after study period filter
n_excluded_period <- n_denom - n_period
print(paste0("Number of excluded studies after study period filter: ", n_excluded_period))

## Filter of sex
df_sex <- df_period %>%
  filter(
    sex == "All"
  )

### Number of unique studies after sex filter
n_sex <- length(unique(df_sex$source_name))
print(paste0("Number of studies after sex filter: ", n_sex))

### Number of excluded studies after sex filter
n_excluded_sex <- n_period - n_sex
print(paste0("Number of excluded studies after sex filter: ", n_excluded_sex))

## Filter of age
df_age <- df_sex %>%
  filter(
    age %in% c(
      "Adults (18-64 years)",
      "Multiple groups")
    )

### Number of unique studies after age filter
n_age <- length(unique(df_age$source_name))
print(paste0("Number of studies after age filter: ", n_age))

### Number of excluded studies after age filter
n_excluded_age <- n_sex - n_age
print(paste0("Number of excluded studies after age filter: ", n_excluded_age))
 
# reorder the columns of the dataframe in the following order: 
# country, first author, source_name, estimate_grade, source_type,....
df_filter <- df_age %>% select(
  country,
  first_author,
  source_name,
  estimate_grade,
  source_type,
  everything()
)

# Keeping only one instance of each study
df_filter <- df_filter %>% 
  distinct(source_name, .keep_all = TRUE)   # keeps only first instance of each study

print(paste0("Number of studies after all the filters: ", nrow(df_filter)))

```
There were studies conducted at different geographical levels in a country.\n
In such cases, if a study was already conducted at a national level, then I \n
skipped the regional and local level studies from that country.\n
Similarly, if a study was conducted at a regional level, then I skipped the\n
local level studies from that country/region.\n

## National studies
```{r}
df_national <- df_filter %>%
  filter(estimate_grade == "National")
nrow(df_national_unique)

setwd(path_data)
write.csv(df_national_unique, "national_studies.csv", row.names = FALSE)
```
There were 112 unique national studies. \n
I exported the studies, reviewed them, and check if they could be included or not.\n
If included, then I did not go through the regional or local studies from the \n
same country. I added a column 'remarks' in the reviewed csv file to indicate whether \n
a study is included or excluded based on the inclusion/exclusion criteria.\n
Now, we will import the modified national studies dataset after review.\n

## Importing the modified national studies after review
```{r}
setwd(path_data)
df_national_modified <- read.csv("national_studies_modified.csv")
table(df_national_modified$remarks)

# Getting the list of countries which have national studies included
countries_national_included <- df_national_modified %>% 
  filter(remarks == "Included") %>%
  select(country)

# Number of studies excluded
n_nat_excl <- nrow(df_national_modified) - nrow(countries_national_included)
print(paste0("Number of national studies excluded: ", n_nat_excl))
```

Now, we will look for regional studies from the countries which do not have national studies.

```{r}

# Studies whose countries have national studies included
df_regional_excluded <- df_filter %>% 
  filter(estimate_grade == "Regional") %>% 
  filter(country %in% countries_national_included$country)
nrow(df_regional_excluded)

# Removing df_regional_excluded from df_filter
df_regional <- df_filter %>% 
  filter(estimate_grade == "Regional") %>%
  filter(!country %in% countries_national_included$country)

# Export the dataset
setwd(path_data)
write.csv(df_regional, "regional_studies.csv", row.names = FALSE)

```

Importing the reviewed dataset
```{r}
setwd(path_data)
df_regional_modified <- read.csv("regional_studies_modified.csv")
table(df_regional_modified$remarks)

# Getting the list of countries which have national studies included
countries_regional_included <- df_regional_modified %>% 
  filter(remarks == "Included") %>%
  select(country)

```
Now, we will look for local studies from the countries which do not have national or regional studies included.\n

## Local studies
```{r}
# Studies whose countries have national studies included
df_reg_nat_excluded <- df_filter %>% 
  filter(estimate_grade == "Local") %>% 
  filter((country %in% countries_national_included$country) | 
           (country %in% countries_regional_included$country)) 

nrow(df_reg_nat_excluded)

# Removing df_national_excluded from df_filter
df_local <- df_filter %>% 
  filter(estimate_grade == "Local") %>%
  filter(!source_name %in% df_reg_nat_excluded$source_name)

# Export the dataset
setwd(path_data)
write.csv(df_local, "local_studies.csv", row.names = FALSE)

```
Importing the reviewed dataset
```{r}
setwd(path_data)
df_local_modified <- read.csv("local_studies_modified.csv")
table(df_local_modified$remarks)

df_local_included <- df_local_modified %>%
  filter(remarks == "Included")

```

I have gone through all the studies and selected a few of them based on the inclusion/exclusion criteria.\n
Now, I will combine all the included studies (national, regional, local) into a final dataset.

```{r}
# Combining all included studies into a final dataset
df_national_included <- df_national_modified %>% 
  filter(remarks == "Included")

df_regional_included <- df_regional_modified %>%
  filter(remarks == "Included")

df_local_included <- df_local_modified %>%
  filter(remarks == "Included")


df_final_included <- rbind(df_national_included,
                           df_regional_included,
                           df_local_included)
head(df_final_included)


```

